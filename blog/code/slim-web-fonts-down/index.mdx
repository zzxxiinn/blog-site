---
title: "slim-web-fonts-down"
date: "2022-08-09"
tags: ["code"]
embeddedImagesLocal:
    - ./before-slim.png
    - ./after-slim.png
    - ./ripgrep-result.png
---

import { getImage, GatsbyImage } from 'gatsby-plugin-image';

## è¿™ç¯‡æ–‡ç« è®²ä»€ä¹ˆï¼Ÿ 
ä½¿ç”¨ `ripgrep` å’Œ `fontmin` åœ¨é¡¹ç›®æ‰“åŒ…æµç¨‹ä¸­åŠ å…¥å­—ä½“ç²¾ç®€ï¼Œä½¿å­—ä½“åº“æ–‡ä»¶å‹ç¼©ï¼Œä½“ç§¯æ›´å°ã€‚

<p style="font-size: 12px; color: #999; margin-bottom: 0;">å‹ç¼©å‰</p>
<GatsbyImage alt='after-slim' image={getImage(props.localImages[0])} title='before-slim'/>

<br />
<br />

<p style="font-size: 12px; color: #999; margin-bottom: 0;">å‹ç¼©å</p>
<GatsbyImage alt='after-slim' image={getImage(props.localImages[1])} title='after-slim'/>


## æˆ‘ä¸ºä»€ä¹ˆå†™è¿™ç¯‡æ–‡ç« ï¼Ÿ
ç§ç§åŸå› ï¼Œåšå®¢åŸŸåä¸åœ¨å›½å†…ï¼Œä¸ºäº†åŠ å¿«åŠ è½½é€Ÿåº¦ï¼Œç²¾ç®€èµ„æºåŒ…å¤§å°ï¼Œå…¶ä¸­æ³¨æ„åˆ°å­—ä½“åº“çš„å¤§å°ï¼Œæ”¶é›†å’Œæ€»ç»“äº†ä»¥ä¸‹æ–¹å¼ã€‚

## æ­£æ–‡

### ä½¿ç”¨ `ripgrep` è·å–é¡¹ç›®ä¸­ä½¿ç”¨åˆ°çš„å­—ç¬¦
#### `ripgrep` æ˜¯ä»€ä¹ˆ
[github ä»“åº“åœ°å€ ğŸ”—](https://github.com/BurntSushi/ripgrep)
> ripgrep æ˜¯ä¸€ä¸ªé¢å‘è¡Œçš„æœç´¢å·¥å…·ï¼Œå®ƒåœ¨éµå¾ª gitignore è§„åˆ™çš„åŒæ—¶ï¼Œé€’å½’åœ°æœç´¢å½“å‰ç›®å½•ä»¥å¯»æ‰¾æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ã€‚  

ä¹Ÿå°±æ˜¯è¯´ï¼Œå®ƒèƒ½æ£€æµ‹æ‰§è¡Œç¯å¢ƒä¸­çš„ `.gitignore` æ–‡ä»¶ï¼Œé€‰æ‹©æ²¡æœ‰è¢«å¿½è§†çš„ç›®å½•ï¼Œé€’å½’çš„æœç´¢ç¬¦åˆæ‰€æä¾›çš„æ­£åˆ™è¡¨è¾¾å¼çš„ **æ–‡ä»¶å†…å®¹** ï¼ˆé»˜è®¤ä¼šå¯¹å½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶ï¼ˆé™¤äº†äºŒè¿›åˆ¶å’Œéšè—æ–‡ä»¶ï¼‰è¿›è¡Œæ£€ç´¢ï¼‰ã€‚

#### æˆ‘æ˜¯è¿™ä¹ˆä½¿ç”¨çš„
```bash
rg -e '[\w\d\p{P}]' ```your-path-here``` -oN --no-filename | sort | uniq | tr -d '\n'
```

<GatsbyImage alt='ripgrep-result' image={getImage(props.localImages[2])} title='ripgrep-result'/>
<br />
<br />


**å…¶ä¸­ï¼š**
- **-e'[\w\d\p{P}]'**  æŒ‡å®šæ­£åˆ™è¡¨è¾¾å¼ï¼Œè¿‡æ»¤å‡ºæ‰€æœ‰å­—ç¬¦ã€æ ‡ç‚¹ç¬¦å·ã€‚
- **-oN --no-filename** æ˜¯æ§åˆ¶æ‰“å°ç»“æœçš„å¼€å…³ï¼Œå› ä¸ºé¢„æœŸåªå¸Œæœ›æ‰“å°å‡ºåŒ¹é…åˆ°çš„å†…å®¹ï¼Œå…¶ä¸­ï¼š
    - **-o** åªæ‰“å°åŒ¹é…çš„å­—ç¬¦ä¸²
    - **-N** ä¸æ‰“å°åŒ¹é…çš„è¡Œå·
    - **--no-filename** ä¸æ‰“å°åŒ¹é…çš„æ–‡ä»¶å
- **sort|uniq** ç”¨äºå¯¹æ±‰å­—è¿›è¡Œæ’åºå»é‡
- **tr -d '\n'** å»æ‰`\n`æ¢è¡Œç¬¦ï¼Œå°†æ‰€æœ‰æ±‰å­—åˆå¹¶åˆ°ä¸€è¡Œï¼Œå…¶ä¸­ -d è¡¨ç¤ºåˆ é™¤

### ä½¿ç”¨ `fontmin` ä»ç›®æ ‡å­—ä½“åº“ä¸­æŒ‘é€‰éœ€è¦çš„æ–‡å­—
#### `fontmin` æ˜¯ä»€ä¹ˆ
[github ä»“åº“åœ°å€ ğŸ”—](https://github.com/ecomfe/fontmin)
Fontmin æ˜¯ä¸€ä¸ªçº¯ JavaScript å®ç°çš„å­—ä½“å­é›†åŒ–æ–¹æ¡ˆã€‚

æä¾›äº† ttf å­é›†åŒ–ï¼Œeot/woff/svg æ ¼å¼è½¬æ¢ï¼Œcss ç”Ÿæˆ ç­‰åŠŸèƒ½ï¼ŒåŠ©æ¨ webfont å‘å±•ï¼Œæå‡ç½‘é¡µæ–‡å­—ä½“éªŒã€‚

#### æ€ä¹ˆä½¿ç”¨å®ƒ
```javascript
var fontmin = new Fontmin()
    .src(fontSrc)
    .use(Fontmin.glyph({
      text: 'Your-characher-here',
      hinting: false            // keep ttf hint info (fpgm, prep, cvt). default = true
    }));

fontmin.run(function (err, files) {
    if (err) { throw err; }
    console.log(files[0])       // { contents: <Buffer 00 01 00 ...> }
}
```


### æ•´åˆè„šæœ¬
è‡ªå·±éœ€æ±‚æ˜¯è·å–æ‰€æœ‰çš„å­—ç¬¦ï¼Œæ•´åˆæˆæ–°çš„å­—ä½“æ–‡ä»¶ï¼Œæœ€åè½¬æˆ base64 åœ¨ä»£ç ä¸­å¼•å…¥ï¼ˆæå‰åŠ è½½ï¼Œä¸æƒ³çœ‹åˆ°å­—ä½“é—ªçƒï¼‰ã€‚

```javascript
async function calcGlyph() {
  let stdout, stderr
  const command = `-e '[\\w\\d\\p{P}]' ${basePath} -oN --no-filename | sort | uniq | tr -d '\\n'`
  if (process.platform === 'darwin') {
    ({ stdout, stderr } = await exec(`${__dirname}/tools/ripgrep-darwin/rg ${command}`));
  } else {
    ({ stdout, stderr } = await exec(`rg ${command}`));
  }

  console.log('ğŸ’¡ Got those characters:', stdout);
  if (stderr) {
    console.error('â›” Got characters failed with error:', stderr);
    throw stderr
  }

  return stdout
}
// contents = fs.readFileSync('/path/to/file.jpg', {encoding: 'base64'});
async function calcGlyph() {
  let stdout, stderr
  const command = `-e '[\\w\\d\\p{P}]' ${basePath} -oN --no-filename | sort | uniq | tr -d '\\n'`
  if (process.platform === 'darwin') {
    ({ stdout, stderr } = await exec(`${__dirname}/tools/ripgrep-darwin/rg ${command}`));
  } else {
    ({ stdout, stderr } = await exec(`rg ${command}`));
  }

  console.log('ğŸ’¡ Got those characters:', stdout);
  if (stderr) {
    console.error('â›” Got characters failed with error:', stderr);
    throw stderr
  }
  return stdout
}

async function genFonts() {
  var fontmin = new Fontmin()
    .src(fontSrc)
    .use(Fontmin.glyph({
      text: await calcGlyph(),
      hinting: false         // keep ttf hint info (fpgm, prep, cvt). default = true
    }));

  fontmin.run(function (err, files) {
    if (err) { throw err; }
    // console.log(files[0].contents.toString('base64'));
    const fontBase64 = files[0].contents.toString('base64');
    const templateFontFamily = `@font-face {
  font-family: "VonwaonBitmap";
  src: url(data:application/font-ttf;charset=utf-8;base64,${fontBase64}) format('truetype');
}`;
    console.log('ğŸ“¦ Generating Fonts at: ', fontDest)
    fs.ensureDirSync(path.dirname(fontDest))
    fs.writeFile(fontDest, templateFontFamily)
    console.log('âœ¨ New font file generated!');
  });
}

genFonts()
```
