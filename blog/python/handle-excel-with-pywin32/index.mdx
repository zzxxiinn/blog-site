---
title: "handle-excel-with-pywin32"
date: "2022-09-13"
tags: ["python", "excel", "pywin32"]
---

win32com æ˜¯ä½¿ç”¨ python é€šè¿‡ RPC å¯¹ Excel VBA çš„å°è£…ã€‚å®ƒå®ç°çš„ä¸€äº›æ–¹æ³•å’Œ VBA æä¾›çš„æ–¹æ³•ç±»ä¼¼ã€‚

- [Excel VBA Reference](https://docs.microsoft.com/en-us/office/vba/api/overview/excel)
ä¸‹é¢è®°å½•ä¸€äº›ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œæœ€å¸¸ç”¨çš„ä¸€äº›æ–¹æ³•å’Œå±æ€§ã€‚

### æ‰“å¼€ Excel åº”ç”¨

```python
from win32com.client import Dispatch, gencache

# ä½¿ç”¨ wps é©±åŠ¨ Excel
xl_app = gencache.EnsureDispatch("ket.Application")

# ä½¿ç”¨ office é©±åŠ¨ Excel
xl_app = Dispatch("Excel.Application")

xl_app.Visible = False      # å¦‚æœæ˜¯True  ä¼šæ‰“å¼€excelç¨‹åºï¼ˆç•Œé¢ï¼‰
xl_app.DisplayAlerts = 0    # ä¸æ˜¾ç¤ºè­¦å‘Šä¿¡æ¯


# æ¨å‡ºå½“å‰ Excel åº”ç”¨å®ä¾‹
xl_app.Quit()
```

### Workbooks

#### æ‰“å¼€ excel
å·¥ä½œç°¿å¼•ç”¨ä» 1 å¼€å§‹(ç›¸å¯¹ä» 0 å¼€å§‹çš„ç¼–ç¨‹æ€ç»´ã€‚ã€‚)

```python
# æ‰“å¼€ excel æ–‡ä»¶ï¼Œè·å–å·¥ä½œç°¿å¯¹è±¡
wb = xl_app.Workbooks.Open("./path-to-excel.xls")
wb = xl_app.Workbooks("Book1")
wb = xl_app.Workbooks('xxx.xlsx')

# ä»¥åªè¯»æ–¹å¼æ‰“å¼€ excel æ–‡ä»¶
wb = xls.Workbooks.Open(fullPath, ReadOnly = False)

# æ‰“å¼€æœ‰å¯†ç çš„ excel æ–‡ä»¶
wb = xls.Workbooks.Open(filepath, UpdateLinks=3, ReadOnly=False, Format=None, Password=passWords)
```


#### å…³é—­ excel

```python

# ä¿å­˜å½“å‰å·¥ä½œç°¿
wb.Save()

# å·¥ä½œç°¿å¦å­˜ä¸º
wb.SaveAs(Filename='C:\\temp\\mysheet.xls')

# ä¿å­˜å¹¶å…³é—­å½“å‰å·¥ä½œç°¿ï¼Œå…¶ä¸­å‚æ•°ä¸º True ä¸ºä¿å­˜ï¼Œ False ä¸ºä¸ä¿å­˜
wb.Close(True)
```

### ä¸€äº›å±æ€§

```PYTHON
wb_count = xl_app.Workbooks.Count   # å·¥ä½œç°¿æ•°é‡
wb_path = xl_app.Workbooks(i).Path  # å·¥ä½œç°¿è·¯å¾„
wb_name = xl_app.Workbooks(i).Name  # å·¥ä½œç°¿åç§°
wb.Checkcompatibility = False
```

## Sheets

### è®¿é—® Sheets å¯¹è±¡
```python
# è·å–å½“å‰æ¿€æ´»çš„ Sheet
ws = xl_app.ActiveSheet  
ws = xl_app.ActiveWorkbook.ActiveSheet

# é€šè¿‡ç´¢å¼•è®¿é—®
ws = xl_app.Workbooks(1).Sheets(1)
ws = wb.Sheets(1)

# é€šè¿‡åç§°è®¿é—®
ws = xl_app.Workbooks("Book1").Sheets("Sheet1")
ws = wb.Sheets("Sheet1")
```

### Sheets å¯¹è±¡çš„ä¸€äº›å±æ€§
```python
wb.Worksheets.Count                                         # è·å–å·¥ä½œè¡¨ä¸ªæ•°
wb.Worksheets(2).Name = 'Details'                           # å·¥ä½œç°¿æ›´å
sheets_names = [ws.Name for ws in wb.Worksheets]            # è·å–å·¥ä½œç°¿æ‰€æœ‰ sheet åç§°
sheets_date =[sheetObj.UsedRange.Value for sheetObj in wb.Worksheets] # è·å–æ‰€æœ‰ sheet çš„å†…å®¹
```

### Sheets å¯¹è±¡å¸¸ç”¨çš„æ–¹æ³•
```python
wb.Worksheets.Add().Name = 'sheet1'                 # æ–°å»ºå·¥ä½œè¡¨sheet1
ws = xls.Sheets(1)=== wb.Worksheets('Sheet1')       # é€‰æ‹©å·¥ä½œè¡¨-é»˜è®¤Sheet1
ws.Activate()                                       # æ¿€æ´»å½“å‰å·¥ä½œè¡¨
ws.Shapes.AddPicture(picturename, 1, 1, Left, Top, Width, Height) # æ·»åŠ å›¾ç‰‡åˆ°Sheet é¡µé¢ä¸­

sheets = wb.Worksheets
ws = shts(1).Copy(None, sheets(1)) 
```

## Range/Cell
Range è¡¨ç¤º excel sheet ä¸­çš„ä¸€ä¸ªåŒºåŸŸï¼Œé€šå¸¸ Range ç”±ä¸€ä¸ªå·¦ä¸Šè§’çš„èµ·å§‹ Cell å’Œ å³ä¸‹è§’çš„ç»“æŸ Cell è¡¨ç¤ºã€‚
Cell æ˜¯ç»„æˆ Range çš„å…ƒå¯¹è±¡

```python
import win32com.client as c
# è®¿é—®ä¸€ä¸ª Cell
ws.Cells(1,1) 

# è®¿é—®æŸä¸ªåŒºåŸŸ
wr = ws.Range("B5:C10")     
wr = ws.Range(ws.Cells(2,2), ws.Cells(3,8))

# è·å–ä½¿ç”¨åŒºåŸŸçš„è¡Œåˆ—æ•°é‡ï¼Œå…¶ä¸­ used.Row è¡¨ç¤ºåŒºåŸŸå¼€å§‹çš„ è¡Œå·ï¼Œ used.Rows.Count è¡¨ç¤ºä¸€å…±å¤šå°‘è¡Œï¼Œåˆ—åŒç†
used = ws.UsedRange
nrows = used.Row + used.Rows.Count - 1
ncols = used.Column + used.Columns.Count - 1

# TODO è¿™é‡Œé‡åˆ°è¿‡ä¸€ä¸ªå¥‡æ€ªçš„é—®é¢˜ï¼Œå°±æ˜¯used.Columns.Count å¼‚å¸¸ï¼Œæµ‹è¯•ç”µè„‘ä¸Šä¸º 1024ï¼ˆå¥‡æ€ª ğŸ§ï¼‰


# è¿™ä¸ªæ–¹æ³•å¯ä»¥æ£€æŸ¥å‡ºæŸä¸€è¡Œä½¿ç”¨çš„ column æ•°é‡
row_count = ws.Cells(1, ws.Columns.Count).End(c.xlToLeft).Column


# è·å–æ‰€æœ‰æ•°æ®
list(ws.Range(ws.Cells(1,2), ws.Cells(row,col)).Value)

# å‘Excelå•å…ƒæ ¼ä¸­å†™å…¥æ•°æ®
wr.Value = 1
wr.Value = list[[1, 2, 3, 4, 5, 6], [2, 3, 4, 5, 6, 7]]

ws.Cells(2, 1).Value = 3
ws.Cells(1, 1).Value = None
ws.Cells(11, 5).offset(3,2).Value = 1

ws.Range('D' + str(10)).value = 3.14                 # ç¬¬åè¡Œ
ws.Range('A1').Value = 'Win32com On Excel'

ws.Range('A2:F2').Value = list('abcDeF')
ws.Range(ws.Cells(3,1),ws.Cells(3,6)).Value = tuple(range(6))
```