---
title: "使用 subprocess.Popen"
date: "2022-12-06"
tags: ["python"]
---

## subprocess.Popen()
`Popen` 是 `subprocess` 的核心方法，子进程的创建和管理都靠它处理

```python
class subprocess.Popen(args, bufsize=- 1, executable=None,
    stdin=None, stdout=None, stderr=None,
    preexec_fn=None, close_fds=True,
    shell=False, cwd=None, env=None, universal_newlines=None,
    startupinfo=None, creationflags=0, restore_signals=True,
    start_new_session=False, pass_fds=(), *, group=None,
    extra_groups=None, user=None, umask=- 1, encoding=None,
    errors=None, text=None, pipesize=- 1, process_group=None)
    ...
```

**常用参数：**

- **args**： shell 中执行的命令，可以是字符串或者序列类型（list、tuple）
- **bufsize**: 缓冲区大小，默认 -1。
    - 0：表示不使用缓存区
    - 1：表示行缓存
    - 正数：缓存区大小
    - 负数：使用系统默认的缓存区大小
- **stdin**, **stdout**, **stderr**：分别表示程序的标准输入、输出、错误句柄
- **preexec_fn**：只在 Unix 平台下有效，用于指定一个可执行对象（callable object），它将在子进程运行之前被调用
- **shell**：如果该参数为 True，将通过操作系统的 shell 执行指定的命令。
    - 在 POSIX 系统中，当 shell=True，shell 默认为 /bin/sh。如果 args 是一个字符串，此字符串指定将通过 shell 执行的命令。这意味着字符串的格式必须和在命令提示符中所输入的完全相同。
    - 在 Windows 中，使用 shell=True，环境变量 COMSPEC 指定了默认 shell。在 Windows 你唯一需要指定 shell=True 的情况是你想要执行内置在 shell 中的命令（例如 dir 或者 copy）。在运行一个批处理文件或者基于控制台的可执行文件时，不需要 shell=True。
- **cwd**：用于设置子进程的当前目录。
- **env**：用于指定子进程的环境变量。如果 env = None，子进程的环境变量将从父进程中继承。

> 同 Linux 中创建子进程类似，父进程创建完子进程之后，并不会自动等待子进程执行，父进程在子进程之前退出将导致子进程成为孤儿进程，孤儿进程统一由 init 进程接管，负责其终止后的回收工作。
> 如果父进程在子进程之后终止，并且父进程没有处理子进程最后的回收工作，子进程残留的数据结构称为**僵尸进程**。


大量的僵尸进程将消耗系统资源，因此必须及时等待和回收子进程，或者能够确认自己比子进程先终止，从而将回收工作过渡给 init 进程。
这个等待和回收子进程的操作就是wait()函数:

```python
import subprocess

p = subprocess.Popen('ls -l', shell=True)
# p = subprocess.Popen(['ls', '-cl'])

print(p.returncode) # 0
p.wait()
```

## Popen 对象
- `p.pid`: 子进程的PID。
- `p.returncode`: 该属性表示子进程的返回状态，returncode可能有多重情况：
    - None —— 子进程尚未结束
    - ==0 —— 子进程正常退出
    - > 0—— 子进程异常退出，returncode对应于出错码
    - < 0—— 子进程被信号杀掉了
- `p.stdin`, `p.stdout`, `p.stderr`:
    子进程对应的一些初始文件，如果调用Popen()的时候对应的参数是subprocess.PIPE，则这里对应的属性是一个包裹了这个管道的 file 对象

**Popen 方法**
- `p.poll()`: 检查子进程  p 是否已经终止，返回 p.returncode 属性
- `p.wait(timeout)`: 等待子进程终止。
- `p.communicate(input, timeout)`: 和子进程交互，发送和读取数据。
- `p.send_signal(signal)`: 发送信号到子进程 。
- `p.teminate()`: 停止子进程,也就是发送 `SIGTERM` 信号到子进程。
- `p.kill()`: 杀死子进程。发送 `SIGKILL` 信号到子进程。

简单的封装：
```python
import time
import subprocess

def cmd(command):
    subp = subprocess.Popen(command,shell=True,stdout=subprocess.PIPE,stderr=subprocess.PIPE,encoding="utf-8")
    subp.wait(2)
    if subp.poll() == 0:
        print(subp.communicate()[1])
    else:
        print("失败")

cmd("java -version")
cmd("exit 1")
```

交互使用：
```python
import subprocess

s = subprocess.Popen("python", stdout=subprocess.PIPE, stdin=subprocess.PIPE, shell=True)
s.stdin.write(b"import os\n")
s.stdin.write(b"print(os.environ)")
s.stdin.close()

out = s.stdout.read().decode("GBK")
s.stdout.close()
print(out)
```